<!DOCTYPE html>
<html lang="en">
<!--
    Commute Compute Setup Wizard - Intelligent Configuration
    Version: 2.0 (Hybrid BLE + Pairing Code Provisioning)

    HYBRID PROVISIONING (see DEVELOPMENT-RULES.md Section 21.7):
      Phase 1 (BLE): WiFi credentials only (SSID + password)
      Phase 2 (Pairing Code): Server config via 6-character code

    Copyright (c) 2026 Angus Bergman
    Licensed under AGPL v3
    See LICENCE for full terms
-->
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a2744">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Wizard - Commute Compute</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a2744;
            min-height: 100vh;
            color: #f1f5f9;
            padding: 20px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        .wizard-card {
            background: #2a3d5f;
            border: 1px solid #3d5278;
            border-radius: 4px;
            padding: 36px;
            margin: 20px 0;
            color: #f1f5f9;
        }

        .wizard-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .wizard-header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #f1f5f9;
        }

        .wizard-header p {
            font-size: 15px;
            color: #94a3b8;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .step {
            width: 32px;
            height: 32px;
            background: #3d5278;
            border-radius: 4px;
            color: #7a8fa8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.15s, color 0.15s;
        }

        .step.active {
            background: #4fb28e;
            color: #1a2744;
        }

        .step.completed {
            background: #22c55e;
            color: #1a2744;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #f1f5f9;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #3d5278;
            border-radius: 4px;
            background: #1a2744;
            color: #f1f5f9;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 15px;
            transition: border-color 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4fb28e;
        }

        .btn {
            background: #4fb28e;
            color: #1a2744;
            border: none;
            border-radius: 4px;
            padding: 12px 28px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn:hover {
            background: #5fcca0;
        }

        .btn-secondary {
            background: #3d5278;
        }

        .btn-secondary:hover {
            background: #4a6291;
        }

        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .info-box {
            background: #243352;
            border-left: 3px solid #0ea5e9;
            border-radius: 4px;
            padding: 14px 16px;
            margin: 16px 0;
            color: #a3b8d0;
            font-size: 13px;
        }

        .success-box {
            background: #166534;
            border-left: 3px solid #22c55e;
            border-radius: 4px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            color: #dcfce7;
        }

        .authority-card {
            background: #243352;
            border: 1px solid #3d5278;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 12px 0;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .authority-card:hover {
            border-color: #4fb28e;
        }

        .authority-card.selected {
            border-color: #4fb28e;
            background: #2a3d5f;
        }

        .authority-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #f1f5f9;
        }

        .authority-desc {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .authority-link {
            font-size: 13px;
            color: #4fb28e;
            text-decoration: none;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
            color: #1a202c !important;
            font-size: 14px;
            line-height: 1.4;
        }

        .autocomplete-item:hover {
            background: #edf2f7;
        }

        /* Version control footer */
        .version-footer {
            margin-top: 30px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
            color: #718096;
            font-family: 'Courier New', monospace;
        }

        .version-footer .version-label {
            font-weight: 600;
            color: #4a5568;
            margin-right: 8px;
        }

        .version-footer .version-value {
            color: #2d3748;
        }

        .version-footer .separator {
            margin: 0 10px;
            color: #cbd5e0;
        }
        /* Icon system - compliant with DEVELOPMENT-RULES Section 22.3 */
        .icon { display: inline-block; width: 20px; height: 20px; vertical-align: middle; }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 32px; height: 32px; }
    </style>
</head>
<body>
    <!-- SVG Icon Sprite - DEVELOPMENT-RULES Section 22.3 Compliant -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-key" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
        </symbol>
        <symbol id="icon-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
        </symbol>
        <symbol id="icon-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </symbol>
        <symbol id="icon-check-circle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </symbol>
        <symbol id="icon-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>
        </symbol>
        <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
        </symbol>
        <symbol id="icon-briefcase" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
        </symbol>
        <symbol id="icon-coffee" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/>
        </symbol>
        <symbol id="icon-train" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="3" width="16" height="16" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/><path d="m9 19-2 3"/><path d="m15 19 2 3"/>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
        </symbol>
        <symbol id="icon-cloud" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
        </symbol>
        <symbol id="icon-tv" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/>
        </symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>
        </symbol>
        <symbol id="icon-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
        </symbol>
        <symbol id="icon-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
        </symbol>
        <symbol id="icon-x-circle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
        </symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </symbol>
    </svg>
    <div class="container">
        <div class="wizard-card">
            <div class="wizard-header">
                <img src="/assets/brand/cc-logo-512.png" alt="Commute Compute" style="width: 280px; height: auto; margin-bottom: 20px;">
                <h1>Welcome to Commute Compute</h1>
                <p>Let's set up your intelligent transit display in just a few steps</p>
                <div style="margin-top: 16px; padding: 8px 16px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 4px; display: inline-block;">
                    <span style="color: #4fb28e; font-size: 13px; font-weight: 600;">Metro Tunnel compatible — Ready for the new network</span>
                </div>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step-1-indicator">1</div>
                <div class="step" id="step-2-indicator">2</div>
                <div class="step" id="step-3-indicator">3</div>
                <div class="step" id="step-4-indicator">4</div>
                <div class="step" id="step-5-indicator">5</div>
            </div>

            <!-- Step 1: Device Setup + WiFi + Factory Reset -->
            <div class="step-content active" id="step-1">
                <h2 style="margin-bottom: 20px;"><svg class="icon"><use href="#icon-tv"/></svg> Step 1: Connect Your Display</h2>
                <p style="color: #94a3b8; margin-bottom: 12px;">
                    Set up your e-ink display using our 2-phase hybrid provisioning system.
                </p>
                <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
                    <p style="color: #667eea; font-size: 12px; margin: 0;">
                        <strong>Requires Chrome or Edge browser</strong> — Web Bluetooth is not supported in Safari or Firefox.
                    </p>
                </div>

                <!-- Device Selection -->
                <div class="form-group">
                    <label class="form-label">Select Your Device</label>
                    <select id="device-select" class="form-input" onchange="updateDeviceSection()">
                        <option value="">No e-ink device (web dashboard only)</option>
                        <option value="trmnl-og">TRMNL Display (OG) - 7.5" 800x480</option>
                        <option value="trmnl-mini" disabled>TRMNL Display (Mini) - Coming Soon</option>
                        <optgroup label="Kindle Devices (Jailbreak Required)">
                            <option value="kindle-pw3">Kindle Paperwhite 3 (6" - 1072x1448)</option>
                            <option value="kindle-pw4">Kindle Paperwhite 4 (6" - 1072x1448)</option>
                            <option value="kindle-pw5">Kindle Paperwhite 5 (6.8" - 1236x1648)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Device Info (shows when TRMNL selected) -->
                <div id="device-info-panel" style="display: none; margin-top: 15px; padding: 15px; background: rgba(79, 178, 142, 0.1); border-radius: 8px; border-left: 3px solid #4fb28e;">
                    <div style="font-size: 11px; color: #fbbf24; margin-bottom: 10px;">
                        <svg class="icon-sm"><use href="#icon-warning"/></svg> Requires flashing with Commute Compute custom firmware (CCFirm)
                    </div>
                </div>

                <!-- WiFi + BLE Provisioning Section (shows when TRMNL selected) -->
                <!-- HYBRID PROVISIONING: Phase 1 (BLE WiFi) + Phase 2 (Pairing Code) -->
                <div id="wifi-provision-section" style="display: none; margin-top: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #f1f5f9;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
                        </svg>
                        Hybrid Device Setup (2 Phases)
                    </h3>

                    <!-- BLE Provisioning (Phase 1: WiFi Only) -->
                    <div id="ble-provision-section" style="padding: 18px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(168, 85, 247, 0.15) 100%); border: 2px solid #667eea; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 15px; color: #667eea; display: flex; align-items: center; gap: 8px;">
                            <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">PHASE 1</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
                            </svg>
                            WiFi Setup via Bluetooth
                        </div>

                        <!-- Privacy Notice -->
                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 10px 12px; margin-bottom: 15px;">
                            <p style="color: #22c55e; font-size: 11px; margin: 0; display: flex; align-items: flex-start; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 1px;">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                <span><strong>Privacy & Security:</strong> Bluetooth communication is encrypted and direct between your browser and device. Your WiFi credentials are sent only to your display and are never transmitted to any server. All data stays local to your network.</span>
                            </p>
                        </div>

                        <p style="color: #f1f5f9; font-size: 13px; margin-bottom: 15px; line-height: 1.5;">
                            Your display should show "DEVICE SETUP" screen. First, click the button below to find and connect to your device.
                        </p>

                        <!-- Step 1: Find Device Button (shown first) -->
                        <div id="ble-find-device-section">
                            <button type="button" id="ble-connect-btn" onclick="connectViaBluetooth()"
                                style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11"/>
                                </svg>
                                Click Here to Find Device
                            </button>
                            <p style="color: #94a3b8; font-size: 11px; margin-top: 10px; text-align: center;">
                                A browser popup will appear. Select your device (e.g., "CommuteCompute-28D0").
                            </p>
                        </div>

                        <!-- Step 2: WiFi Credentials (hidden until connected) -->
                        <div id="ble-wifi-credentials-section" style="display: none;">
                            <div style="background: rgba(102, 126, 234, 0.15); border-radius: 6px; padding: 10px; margin-bottom: 12px; text-align: center;">
                                <span style="color: #667eea; font-size: 13px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                    Connected to device! Now select your WiFi network:
                                </span>
                            </div>

                            <div style="display: grid; gap: 12px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px;">Select WiFi Network</label>
                                    <select id="ble-wifi-ssid-select"
                                        style="width: 100%; padding: 12px; font-size: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(102, 126, 234, 0.5); border-radius: 6px; color: #f1f5f9; cursor: pointer;"
                                        onchange="document.getElementById('ble-wifi-ssid').value = this.value;">
                                        <option value="">Select a network...</option>
                                    </select>
                                    <input type="text" id="ble-wifi-ssid"
                                        placeholder="Or type network name manually"
                                        style="width: 100%; padding: 12px; font-size: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(102, 126, 234, 0.5); border-radius: 6px; color: #f1f5f9; margin-top: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px;">WiFi Password</label>
                                    <input type="password" id="ble-wifi-password"
                                        placeholder="Enter your WiFi password"
                                        style="width: 100%; padding: 12px; font-size: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(102, 126, 234, 0.5); border-radius: 6px; color: #f1f5f9;">
                                </div>
                            </div>

                            <button type="button" id="ble-send-credentials-btn" onclick="sendBLECredentials(document.getElementById('ble-status'), this)"
                                style="width: 100%; padding: 14px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                                Send WiFi Credentials to Device
                            </button>
                        </div>

                        <!-- Status -->
                        <div id="ble-status" style="margin-top: 12px; text-align: center; font-size: 13px;"></div>

                        <p style="color: #94a3b8; font-size: 11px; margin-top: 12px; text-align: center;">
                            Your display must show "DEVICE SETUP" screen with instructions matching this wizard.
                        </p>
                    </div>

                    <!-- Pairing Code (Phase 2: Server Config) -->
                    <div id="pairing-divider" style="text-align: center; position: relative; margin: 20px 0;">
                        <span style="background: #2a3d5f; padding: 0 12px; color: #94a3b8; font-size: 12px; position: relative; z-index: 1;">AFTER WiFi connects, enter pairing code</span>
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.1);"></div>
                    </div>

                    <div id="device-pairing-section" style="padding: 18px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 10px;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 14px; color: #4fb28e; display: flex; align-items: center; gap: 8px;">
                            <span style="background: #4fb28e; color: #1a2744; padding: 2px 8px; border-radius: 4px; font-size: 12px;">PHASE 2</span>
                            <svg class="icon"><use href="#icon-link"/></svg>
                            Enter Pairing Code from Display
                        </div>
                        <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px; line-height: 1.5;">
                            Once WiFi is connected, your display will refresh and show a <strong>6-character pairing code</strong> (e.g., A7X9K2). Enter it below to link your configuration to the device.
                        </p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="device-pairing-code"
                                placeholder="A7X9K2"
                                maxlength="6"
                                style="flex: 1; padding: 12px; font-size: 20px; font-family: monospace; text-transform: uppercase; letter-spacing: 4px; text-align: center; background: rgba(0,0,0,0.3); border: 1px solid rgba(79, 178, 142, 0.5); border-radius: 8px; color: #f1f5f9; font-weight: bold;"
                                oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6); validatePairingCode();">
                            <span id="pairing-code-status" style="font-size: 20px;"></span>
                        </div>
                        <p style="color: #64748b; font-size: 10px; margin-top: 8px;">
                            Code expires after 10 minutes.
                        </p>
                    </div>
                </div>

                <!-- Factory Reset Section -->
                <div id="factory-reset-section" style="display: none; margin-top: 25px; padding: 15px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #ef4444; display: flex; align-items: center; gap: 8px;">
                        <svg class="icon"><use href="#icon-refresh"/></svg>
                        Factory Reset Device
                    </div>
                    <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">
                        Clear all stored WiFi credentials and pairing data from your device. Use this if you need to reconfigure or move to a new network.
                    </p>
                    <button type="button" onclick="factoryResetDevice()"
                        style="padding: 10px 20px; font-size: 13px; font-weight: 600; background: #ef4444; border: none; border-radius: 6px; color: white; cursor: pointer;">
                        Reset Device Settings
                    </button>
                    <div id="reset-status" style="margin-top: 10px; font-size: 12px;"></div>
                </div>

                <!-- Skip info for web-only users -->
                <div id="web-only-info" style="margin-top: 20px; padding: 15px; background: rgba(79, 178, 142, 0.1); border-radius: 8px; border-left: 3px solid #4fb28e;">
                    <p style="color: #f1f5f9; font-size: 13px; margin: 0;">
                        <strong>No device?</strong> No problem! You can still use the web dashboard to view your commute information on any browser.
                    </p>
                </div>

                <!-- Wipe All Data Section -->
                <div style="margin-top: 25px; padding: 18px; background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #ef4444; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                        Start Fresh / Wipe All Data
                    </div>
                    <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px; line-height: 1.5;">
                        Completely reset your Commute Compute setup. This will delete:
                    </p>
                    <ul style="color: #94a3b8; font-size: 12px; margin: 0 0 15px 20px; line-height: 1.6;">
                        <li>All saved addresses and journey configurations</li>
                        <li>Google Places and Transit API keys</li>
                        <li>Device pairings and webhook URLs</li>
                        <li>All cached data (local browser storage)</li>
                        <li>All server-side data (Vercel KV storage)</li>
                    </ul>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" id="wipe-all-data-btn" onclick="wipeAllData()"
                            style="padding: 10px 18px; font-size: 13px; font-weight: 600; background: #ef4444; border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            </svg>
                            Wipe All Data
                        </button>
                        <button type="button" id="clear-local-only-btn" onclick="clearLocalStorageOnly()"
                            style="padding: 10px 18px; font-size: 13px; font-weight: 500; background: transparent; border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 6px; color: #ef4444; cursor: pointer;">
                            Clear Browser Cache Only
                        </button>
                    </div>
                    <div id="wipe-status" style="margin-top: 12px; font-size: 12px;"></div>
                </div>

                <div class="btn-row" style="margin-top: 25px;">
                    <button type="button" class="btn" onclick="nextStep(1)" id="step-1-next-btn">
                        Next: Google Places API →
                    </button>
                </div>
            </div>

            <!-- Step 2: Google Places API Key -->
            <div class="step-content" id="step-2">
                <h2 style="margin-bottom: 20px;"><svg class="icon"><use href="#icon-key"/></svg> Step 2: Google Places API Key (Recommended)</h2>
                <p style="color: #94a3b8; margin-bottom: 25px;">
                    For accurate address geocoding, we recommend adding your <strong>Google Places API (new)</strong> key.
                </p>

                <div class="info-box">
                    <strong>Why is this recommended?</strong><br>
                    Google Places provides highly accurate address autocomplete. However, you can <strong>skip this</strong> — we'll use free OpenStreetMap geocoding instead.
                </div>

                <div class="form-group" style="margin-top: 25px;">
                    <label class="form-label">Google Places API (New) Key (Optional)</label>
                    <input type="text" id="google-places-api-key" class="form-input" placeholder="Enter your Google Places API (new) key..." autocomplete="off" inputmode="text">
                    <a href="https://console.cloud.google.com/apis/library/places-backend.googleapis.com" target="_blank" style="font-size: 13px; color: #4fb28e; display: block; margin-top: 8px;">
                        Get Google Places API key (has free tier) →
                    </a>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn" onclick="saveAndTestGoogleKey()" style="background: #48bb78; flex: 1;" id="save-api-key-btn">
                        <svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test API Key
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="skipGoogleKey()" style="flex: 1;">
                        Skip for Now
                    </button>
                </div>

                <div id="api-key-status" style="margin-top: 15px; display: none;"></div>
                <div id="skip-warning" style="display: none; margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px;">
                    <strong style="color: #fbbf24;"><svg class="icon-sm"><use href="#icon-warning"/></svg> Using OpenStreetMap</strong>
                    <p style="color: #94a3b8; font-size: 13px; margin-top: 8px; margin-bottom: 0;">
                        Address autocomplete will use OpenStreetMap. This works well for Australian addresses.
                    </p>
                </div>

                <div class="btn-row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="previousStep(2)">← Back</button>
                    <button type="button" class="btn" onclick="nextStep(2)" id="step-2-next-btn" style="display: none;">Next: Your Addresses →</button>
                </div>
            </div>

            <!-- Step 3: Addresses -->
            <div class="step-content" id="step-3">
                <h2 style="margin-bottom: 20px;"><svg class="icon"><use href="#icon-pin"/></svg> Step 3: Your Addresses</h2>
                <p style="color: #718096; margin-bottom: 25px;">
                    Enter your home and work addresses. We'll automatically detect your state and suggest the right transit authority.
                </p>

                <div class="form-group" style="position: relative;">
                    <label class="form-label"><svg class="icon-sm"><use href="#icon-home"/></svg> Home Address</label>
                    <input type="text" id="home-address" class="form-input" placeholder="Start typing your home address..." autocomplete="off" inputmode="text">
                    <div id="home-suggestions" class="autocomplete-dropdown"></div>
                </div>

                <div class="form-group" style="position: relative;">
                    <label class="form-label"><svg class="icon-sm"><use href="#icon-briefcase"/></svg> Work Address</label>
                    <input type="text" id="work-address" class="form-input" placeholder="Start typing your work address..." autocomplete="off" inputmode="text">
                    <div id="work-suggestions" class="autocomplete-dropdown"></div>
                </div>

                <div class="form-group" style="position: relative;">
                    <label class="form-label"><svg class="icon-sm"><use href="#icon-coffee"/></svg> Favorite Cafe (Optional)</label>
                    <input type="text" id="cafe-address" class="form-input" placeholder="Your go-to coffee spot..." autocomplete="off" inputmode="text">
                    <div id="cafe-suggestions" class="autocomplete-dropdown"></div>
                </div>

                <div id="state-detection" style="display: none;" class="info-box">
                    <strong><svg class="icon-sm" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> Detected:</strong> <span id="detected-state"></span>
                </div>

                <div class="btn-row">
                    <button type="button" class="btn btn-secondary" onclick="previousStep(3)">← Back</button>
                    <button type="button" class="btn" onclick="nextStep(3)">Next: Transit Authority →</button>
                </div>
            </div>

            <!-- Step 4: Transit Authority -->
            <div class="step-content" id="step-4">
                <h2 style="margin-bottom: 20px;"><svg class="icon"><use href="#icon-train"/></svg> Step 4: Transit Authority</h2>
                <p style="color: #94a3b8; margin-bottom: 25px;">
                    We've detected your location. Please confirm or choose your transit authority.
                </p>

                <div id="authority-list"></div>

                <div class="btn-row">
                    <button type="button" class="btn btn-secondary" onclick="previousStep(4)">← Back</button>
                    <button type="button" class="btn" onclick="nextStep(4)">Next: Journey Settings →</button>
                </div>
            </div>

            <!-- Step 5: Journey Settings + Transit API + Complete -->
            <div class="step-content" id="step-5">
                <form novalidate onsubmit="return false;">
                    <h2 style="margin-bottom: 20px;"><svg class="icon"><use href="#icon-clock"/></svg> Step 5: Journey Settings</h2>
                    <p style="color: #94a3b8; margin-bottom: 25px;">
                        Configure your commute preferences and optional real-time transit API.
                    </p>

                    <!-- Transit API Key Section -->
                    <div style="padding: 18px; background: rgba(79, 178, 142, 0.1); border: 1px solid rgba(79, 178, 142, 0.3); border-radius: 10px; margin-bottom: 25px;">
                        <h3 style="font-size: 15px; margin-bottom: 12px; color: #4fb28e;">
                            <svg class="icon-sm"><use href="#icon-key"/></svg> Transit API Key (Optional)
                        </h3>
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 15px;">
                            For real-time delays and cancellations. Without it, we'll use timetable data.
                        </p>

                        <div id="api-info" class="info-box" style="margin-bottom: 15px;"></div>
                        <div id="api-credentials-form"></div>
                        <div id="transit-api-status" style="margin: 10px 0; display: none;"></div>

                        <div style="display: flex; gap: 10px;">
                            <button type="button" id="save-transit-key-btn" onclick="saveAndTestTransitKey()"
                                style="flex: 1; padding: 10px; font-size: 13px; background: #48bb78; border: none; border-radius: 6px; color: white; cursor: pointer;">
                                <svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test
                            </button>
                            <button type="button" id="skip-transit-btn" onclick="skipTransitKey()"
                                style="flex: 1; padding: 10px; font-size: 13px; background: #64748b; border: none; border-radius: 6px; color: white; cursor: pointer;">
                                Skip (Timetable Only)
                            </button>
                        </div>
                    </div>

                    <!-- Journey Preferences -->
                    <div class="form-group">
                        <label class="form-label">Arrival Time at Work</label>
                        <input type="text" id="arrival-time" class="form-input" value="09:00" placeholder="e.g. 09:00" autocomplete="off" inputmode="text">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="include-coffee" checked style="margin-right: 8px;">
                            Calculate coffee stop times
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 20px; padding: 15px; background: rgba(79, 178, 142, 0.1); border-radius: 8px;">
                        <label class="form-label" style="margin-bottom: 10px;"><svg class="icon-sm"><use href="#icon-cloud"/></svg> API Usage Mode</label>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="api-mode" value="cached" checked style="margin-right: 8px;">
                                <span><strong>Free Mode</strong> — Use cached data (no runtime API calls)</span>
                            </label>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="api-mode" value="live" style="margin-right: 8px;">
                                <span><strong>Live Mode</strong> — Real-time cafe busy-ness (uses Google API)</span>
                            </label>
                        </div>
                    </div>

                    <div id="setup-status"></div>
                    
                    <!-- Fallback navigation - always visible after attempting setup -->
                    <div id="manual-navigation" style="display: none; margin-top: 20px; padding: 15px; background: rgba(79, 178, 142, 0.15); border: 2px solid #4fb28e; border-radius: 8px; text-align: center;">
                        <p style="color: #f1f5f9; margin-bottom: 10px; font-weight: 600;"><svg class="icon-sm" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> Setup submitted!</p>
                        <a href="/admin.html" class="btn" style="display: inline-block; text-decoration: none; background: #4fb28e; color: #fff; padding: 12px 24px; border-radius: 8px; font-weight: 600;">
                            Go to Dashboard →
                        </a>
                    </div>

                    <div class="btn-row" id="setup-buttons">
                        <button type="button" class="btn btn-secondary" onclick="previousStep(5)">← Back</button>
                        <button type="button" class="btn" id="complete-setup-btn" formnovalidate><svg class="icon-sm"><use href="#icon-check-circle"/></svg> Complete Setup</button>
                    </div>
                </form>
                <script>
                    document.getElementById('complete-setup-btn').addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        completeSetup();
                        return false;
                    });
                </script>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; font-size: 13px; opacity: 0.8;">
            © 2026 Angus Bergman. Licensed under AGPL v3
    See LICENCE for full terms
        </div>

        <!-- Version Control Footer -->
        <div class="version-footer">
            <span class="version-label">Version:</span>
            <span class="version-value" id="versionHash">Loading...</span>
            <span class="separator">•</span>
            <span class="version-label">Build:</span>
            <span class="version-value" id="buildDate">Loading...</span>
        </div>

    </div>
    
    <!-- Footer -->
    <footer style="background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(255,255,255,0.1); padding: 24px 20px; margin-top: 40px; text-align: center; font-size: 13px; color: #94a3b8;">
        <div style="max-width: 800px; margin: 0 auto;">
            <!-- Attribution -->
            <div style="margin-bottom: 16px;">
                <strong>Data:</strong>
                <a href="https://opendata.transport.vic.gov.au" target="_blank" rel="noopener" style="color: #94a3b8;">Transport Victoria OpenData</a> (CC BY 4.0) •
                <a href="https://www.bom.gov.au" target="_blank" rel="noopener" style="color: #94a3b8;">Bureau of Meteorology</a> •
                <a href="/attribution.html" style="color: #94a3b8;">All Sources</a>
            </div>
            
            <!-- Support Buttons -->
            <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                <a href="https://buymeacoffee.com/angusbergman" target="_blank" rel="noopener" 
                   style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: #FFDD00; color: #000; border-radius: 8px; text-decoration: none; font-weight: 500; font-size: 13px;">
                    <svg class="icon-sm"><use href="#icon-coffee"/></svg> Buy me a coffee
                </a>
                <a href="https://github.com/sponsors/angusbergman17-cpu" target="_blank" rel="noopener"
                   style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: #db61a2; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 500; font-size: 13px;">
                    <svg class="icon-sm"><use href="#icon-heart"/></svg> Sponsor
                </a>
                <a href="https://github.com/angusbergman17-cpu/CommuteCompute/issues/new?template=feedback.md&title=[Setup Feedback]" target="_blank" rel="noopener"
                   style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: #4fb28e; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 500; font-size: 13px;">
                    Feedback
                </a>
            </div>
            
            <!-- Legal -->
            <div style="font-size: 12px;">
                © 2025-2026 <a href="https://github.com/angusbergman17-cpu" target="_blank" rel="noopener" style="color: #94a3b8;">Angus Bergman</a> •
                <a href="/LICENCE" target="_blank" style="color: #4fb28e;">AGPL v3</a> •
                Commute Compute <span id="footer-version">v2.8</span>
            </div>
        </div>
    </footer>

    <script>
        // XSS Sanitization utility - escapes HTML special characters
        function sanitize(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'};
            return str.replace(/[&<>"'`=/]/g, c => map[c]);
        }

        // Set version control info
        fetch('/api/version')
            .then(r => r.json())
            .then(v => {
                document.getElementById('versionHash').textContent = v.version || 'v2.5.0';
                document.getElementById('buildDate').textContent = v.date || new Date().toISOString().split('T')[0];
            })
            .catch(() => {
                document.getElementById('versionHash').textContent = 'v2.5.0';
                document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
            });

        // Load required attributions
        fetch('/api/attributions')
            .then(r => r.json())
            .then(data => {
                const content = document.getElementById('attributions-content');
                if (data.attributions && data.attributions.length > 0) {
                    content.innerHTML = data.attributions.map(attr =>
                        `<div style="margin-bottom: 3px;">• ${attr.text}</div>`
                    ).join('');
                }
            })
            .catch(() => {
                document.getElementById('attributions-content').innerHTML = 'Created by Angus Bergman • AGPL v3';
            });
    </script>
    <script type="module">
        let currentStep = 1;
        let selectedAuthority = null;
        let detectedState = null;
        let addresses = {};
        let autocompleteDebounce = null;

        // Transit Authorities Configuration
        const AUTHORITIES = {
            VIC: { name: 'Transport Victoria OpenData', state: 'Victoria', url: 'https://opendata.transport.vic.gov.au/' },
            NSW: { name: 'Transport for NSW', state: 'New South Wales', url: 'https://opendata.transport.nsw.gov.au/user/register' },
            QLD: { name: 'TransLink Queensland', state: 'Queensland', url: 'https://www.data.qld.gov.au/' },
            WA: { name: 'Transperth', state: 'Western Australia', url: 'https://www.transperth.wa.gov.au/About/Spatial-Data-Access' },
            SA: { name: 'Adelaide Metro', state: 'South Australia', url: 'https://data.sa.gov.au/' },
            TAS: { name: 'Metro Tasmania', state: 'Tasmania', url: 'https://www.metrotas.com.au/' },
            ACT: { name: 'Transport Canberra', state: 'ACT', url: 'https://www.data.act.gov.au/' },
            NT: { name: 'Darwin Bus Service', state: 'Northern Territory', url: 'https://nt.gov.au/driving/public-transport-cycling' }
        };

        function detectState(address) {
            const lower = address.toLowerCase();
            if (lower.includes('melbourne') || lower.includes('victoria') || lower.includes('geelong')) return 'VIC';
            if (lower.includes('sydney') || lower.includes('nsw')) return 'NSW';
            if (lower.includes('brisbane') || lower.includes('queensland') || lower.includes('gold coast')) return 'QLD';
            if (lower.includes('perth') || lower.includes('western australia')) return 'WA';
            if (lower.includes('adelaide') || lower.includes('south australia')) return 'SA';
            if (lower.includes('hobart') || lower.includes('tasmania')) return 'TAS';
            if (lower.includes('canberra')) return 'ACT';
            if (lower.includes('darwin')) return 'NT';
            return null;
        }

        function setupAddressAutocomplete(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);

            input.addEventListener('input', function() {
                clearTimeout(autocompleteDebounce);
                const query = this.value.trim();

                if (query.length < 3) {
                    suggestions.style.display = 'none';
                    return;
                }

                autocompleteDebounce = setTimeout(async () => {
                    try {
                        // Get Google key from localStorage if validated
                        const googleKey = localStorage.getItem('cc-google-places-key');
                        const googleValidated = localStorage.getItem('cc-google-places-validated') === 'true';
                        
                        let url = `/api/address-search?q=${encodeURIComponent(query)}`;
                        if (googleKey && googleValidated) {
                            url += `&googleKey=${encodeURIComponent(googleKey)}`;
                        }
                        
                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.results && data.results.length > 0) {
                            const sourceIndicator = data.source === 'google' ? '🔵 Google Places' : '🟢 OpenStreetMap';
                            suggestions.innerHTML = data.results.map(r => `
                                <div class="autocomplete-item" onclick="selectAddress('${inputId}', '${suggestionsId}', '${r.display_name.replace(/'/g, "\\'")}')">
                                    ${r.display_name}
                                </div>
                            `).join('');
                            suggestions.innerHTML += `<div style="padding: 6px 12px; font-size: 10px; opacity: 0.5; border-top: 1px solid rgba(255,255,255,0.1); text-align: right;">${sourceIndicator}</div>`;
                            suggestions.style.display = 'block';
                            console.log('Address suggestions from:', data.source);
                        } else {
                            suggestions.style.display = 'none';
                        }
                    } catch (e) {
                        console.error('Autocomplete error:', e);
                    }
                }, 500);
            });
        }

        window.selectAddress = function(inputId, suggestionsId, address) {
            document.getElementById(inputId).value = address;
            document.getElementById(suggestionsId).style.display = 'none';

            // Detect state
            if (inputId === 'home-address' || inputId === 'work-address') {
                const state = detectState(address);
                if (state && !detectedState) {
                    detectedState = state;
                    document.getElementById('state-detection').style.display = 'block';
                    document.getElementById('detected-state').textContent = AUTHORITIES[state].state;
                }
            }
        };

        // Device selection functions
        function toggleDeviceSection() {
            const content = document.getElementById('device-section-content');
            const arrow = document.getElementById('device-section-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        window.toggleDeviceSection = toggleDeviceSection;
        
        function updateDevicePreview() {
            const select = document.getElementById('device-select');
            const preview = document.getElementById('device-preview');
            const warning = document.getElementById('trmnl-model-warning');
            const pairingSection = document.getElementById('device-pairing-section');
            const bleSection = document.getElementById('ble-provision-section');
            const pairingDivider = document.getElementById('pairing-divider');
            const previewName = document.getElementById('device-preview-name');
            const previewSpecs = document.getElementById('device-preview-specs');

            const device = select.value;

            if (!device) {
                preview.style.display = 'none';
                warning.style.display = 'none';
                if (pairingSection) pairingSection.style.display = 'none';
                if (bleSection) bleSection.style.display = 'none';
                if (pairingDivider) pairingDivider.style.display = 'none';
                return;
            }

            preview.style.display = 'block';

            const deviceInfo = {
                'trmnl-og': { name: 'TRMNL Display (OG)', specs: 'Resolution: 800×480 pixels • Orientation: Landscape • Chip: ESP32-C3', hasPairing: true, hasBLE: true },
                'trmnl-mini': { name: 'TRMNL Display (Mini)', specs: 'Resolution: 600×448 pixels • Orientation: Landscape', hasPairing: true, hasBLE: true },
                'kindle-pw3': { name: 'Kindle Paperwhite 3', specs: 'Resolution: 1072×1448 pixels • Orientation: Portrait • 6" display', hasPairing: false, hasBLE: false },
                'kindle-pw4': { name: 'Kindle Paperwhite 4', specs: 'Resolution: 1072×1448 pixels • Orientation: Portrait • 6" display', hasPairing: false, hasBLE: false },
                'kindle-pw5': { name: 'Kindle Paperwhite 5', specs: 'Resolution: 1236×1648 pixels • Orientation: Portrait • 6.8" display', hasPairing: false, hasBLE: false }
            };

            const info = deviceInfo[device] || { name: device, specs: 'Unknown device', hasPairing: false, hasBLE: false };
            previewName.textContent = info.name;
            previewSpecs.textContent = info.specs;

            // Show warning for TRMNL devices
            warning.style.display = device.startsWith('trmnl') ? 'block' : 'none';

            // Show BLE provisioning section for devices that support it (primary method)
            if (bleSection) {
                bleSection.style.display = info.hasBLE ? 'block' : 'none';
            }

            // Show divider and pairing code section as fallback
            if (pairingDivider) {
                pairingDivider.style.display = info.hasPairing ? 'block' : 'none';
            }
            if (pairingSection) {
                pairingSection.style.display = info.hasPairing ? 'block' : 'none';
            }
        }
        window.updateDevicePreview = updateDevicePreview;

        // Validate pairing code format
        function validatePairingCode() {
            const input = document.getElementById('device-pairing-code');
            const status = document.getElementById('pairing-code-status');
            const code = input.value.trim();

            if (code.length === 0) {
                status.textContent = '';
            } else if (code.length < 6) {
                status.textContent = '';
            } else if (code.length === 6 && /^[A-Z0-9]{6}$/.test(code)) {
                status.textContent = '✓';
                status.style.color = '#22c55e';
            } else {
                status.textContent = '✗';
                status.style.color = '#f87171';
            }
        }
        window.validatePairingCode = validatePairingCode;

        // ============================================
        // BLE PROVISIONING (Web Bluetooth API)
        // ============================================

        // BLE Service and Characteristic UUIDs (must match firmware v7.1+)
        // TURNKEY PROVISIONING: BLE sends WiFi + Server URL (auto-detected from window.location.origin)
        const BLE_SERVICE_UUID = 'cc000001-0000-1000-8000-00805f9b34fb';
        const BLE_CHAR_SSID_UUID = 'cc000002-0000-1000-8000-00805f9b34fb';
        const BLE_CHAR_PASSWORD_UUID = 'cc000003-0000-1000-8000-00805f9b34fb';
        const BLE_CHAR_SERVER_UUID = 'cc000004-0000-1000-8000-00805f9b34fb';
        const BLE_CHAR_STATUS_UUID = 'cc000005-0000-1000-8000-00805f9b34fb';
        const BLE_CHAR_WIFI_LIST_UUID = 'cc000006-0000-1000-8000-00805f9b34fb';

        let bleDevice = null;
        let bleServer = null;
        let bleService = null;

        async function connectViaBluetooth() {
            const statusDiv = document.getElementById('ble-status');
            const connectBtn = document.getElementById('ble-connect-btn');
            const findDeviceSection = document.getElementById('ble-find-device-section');
            const credentialsSection = document.getElementById('ble-wifi-credentials-section');

            // Check Web Bluetooth support
            if (!navigator.bluetooth) {
                statusDiv.innerHTML = '<span style="color: #f87171;">Web Bluetooth is not supported in this browser. Please use Chrome or Edge.</span>';
                return;
            }

            // Disable button during connection
            connectBtn.disabled = true;
            connectBtn.style.opacity = '0.6';
            statusDiv.innerHTML = '<span style="color: #667eea;">Searching for your display...</span>';

            try {
                // Request Bluetooth device
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'CommuteCompute' }
                    ],
                    optionalServices: [BLE_SERVICE_UUID]
                });

                statusDiv.innerHTML = `<span style="color: #667eea;">Connecting to ${bleDevice.name}...</span>`;

                // Connect to GATT server
                bleServer = await bleDevice.gatt.connect();
                statusDiv.innerHTML = '<span style="color: #22c55e;">Connected! Scanning for WiFi networks...</span>';

                // Get the provisioning service
                bleService = await bleServer.getPrimaryService(BLE_SERVICE_UUID);

                // Read WiFi network list
                const select = document.getElementById('ble-wifi-ssid-select');
                try {
                    const charWiFiList = await bleService.getCharacteristic(BLE_CHAR_WIFI_LIST_UUID);
                    const wifiListValue = await charWiFiList.readValue();
                    const wifiList = new TextDecoder().decode(wifiListValue);

                    if (wifiList && wifiList.length > 0) {
                        const networks = wifiList.split(',').filter(n => n.length > 0);

                        // Populate dropdown
                        select.innerHTML = '<option value="">Select your WiFi network...</option>';
                        networks.forEach(ssid => {
                            const option = document.createElement('option');
                            option.value = ssid;
                            option.textContent = ssid;
                            select.appendChild(option);
                        });

                        // Add "Other..." option
                        const otherOption = document.createElement('option');
                        otherOption.value = '__other__';
                        otherOption.textContent = '-- Enter network name manually --';
                        select.appendChild(otherOption);

                        // Handle selection
                        select.onchange = function() {
                            const input = document.getElementById('ble-wifi-ssid');
                            if (this.value === '__other__') {
                                input.style.display = 'block';
                                input.placeholder = 'Enter network name';
                                input.focus();
                            } else {
                                input.value = this.value;
                                input.style.display = 'none';
                            }
                        };

                        console.log('[BLE] Found networks:', networks);
                        statusDiv.innerHTML = `<span style="color: #22c55e;">Found ${networks.length} network${networks.length !== 1 ? 's' : ''}. Select yours below.</span>`;
                    } else {
                        select.innerHTML = '<option value="">No networks found - enter manually</option>';
                        document.getElementById('ble-wifi-ssid').style.display = 'block';
                        statusDiv.innerHTML = '<span style="color: #fbbf24;">No networks found. Enter your network name manually.</span>';
                    }
                } catch (e) {
                    console.log('[BLE] Could not read WiFi list:', e);
                    select.innerHTML = '<option value="">Enter network manually below</option>';
                    document.getElementById('ble-wifi-ssid').style.display = 'block';
                    statusDiv.innerHTML = '<span style="color: #667eea;">Connected! Enter your WiFi details below.</span>';
                }

                // Hide "Find Device" button, show credentials form
                findDeviceSection.style.display = 'none';
                credentialsSection.style.display = 'block';

                // Focus password field after a moment
                setTimeout(() => {
                    document.getElementById('ble-wifi-password').focus();
                }, 300);

            } catch (error) {
                console.error('[BLE] Error:', error);

                let errorMessage = 'Connection failed. ';
                if (error.name === 'NotFoundError') {
                    errorMessage = 'No device selected. Make sure your display shows "DEVICE SETUP" screen.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Bluetooth access denied. Please allow Bluetooth access and try again.';
                } else if (error.name === 'NetworkError') {
                    errorMessage = 'Connection lost. Please try again.';
                } else {
                    errorMessage += error.message || 'Please try again.';
                }

                statusDiv.innerHTML = `<span style="color: #f87171;">${errorMessage}</span>`;
                connectBtn.disabled = false;
                connectBtn.style.opacity = '1';
            }
        }
        window.connectViaBluetooth = connectViaBluetooth;

        // Send credentials after network selection
        async function sendBLECredentials(statusDiv, sendBtn) {
            // HYBRID PROVISIONING Phase 1: Send WiFi credentials only
            // URL/server config comes via pairing code (Phase 2)
            if (!statusDiv) statusDiv = document.getElementById('ble-status');
            if (!sendBtn) sendBtn = document.getElementById('ble-send-credentials-btn');

            const ssidInput = document.getElementById('ble-wifi-ssid');
            const ssidSelect = document.getElementById('ble-wifi-ssid-select');
            const passwordInput = document.getElementById('ble-wifi-password');

            // Get SSID from dropdown first, then input if dropdown shows "other" or empty
            let ssid = '';
            const selectValue = ssidSelect?.value || '';
            if (selectValue && selectValue !== '' && selectValue !== '__other__') {
                ssid = selectValue;
            } else {
                ssid = ssidInput?.value?.trim() || '';
            }

            const password = passwordInput?.value || '';

            if (!ssid) {
                statusDiv.innerHTML = '<span style="color: #f87171;">Please select or enter a WiFi network name</span>';
                ssidSelect?.focus();
                return;
            }

            if (!password) {
                statusDiv.innerHTML = '<span style="color: #f87171;">Please enter your WiFi password</span>';
                passwordInput?.focus();
                return;
            }

            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.6';
            }
            statusDiv.innerHTML = '<span style="color: #667eea;">Sending WiFi credentials...</span>';

            try {
                const service = bleService;

                // Get characteristics (WiFi + Server URL for turnkey)
                const charSSID = await service.getCharacteristic(BLE_CHAR_SSID_UUID);
                const charPassword = await service.getCharacteristic(BLE_CHAR_PASSWORD_UUID);
                const charServer = await service.getCharacteristic(BLE_CHAR_SERVER_UUID);
                const charStatus = await service.getCharacteristic(BLE_CHAR_STATUS_UUID);

                // Subscribe to status notifications
                await charStatus.startNotifications();
                charStatus.addEventListener('characteristicvaluechanged', (event) => {
                    const value = new TextDecoder().decode(event.target.value);
                    console.log('[BLE] Status update:', value);

                    // v7.1+ firmware sends 'wifi_saved' (not 'credentials_saved')
                    if (value === 'wifi_saved' || value === 'credentials_saved') {
                        // HYBRID: WiFi saved, now show pairing code prompt
                        statusDiv.innerHTML = `
                            <div style="color: #22c55e; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
                                    <svg class="icon-sm"><use href="#icon-check-circle"/></svg>
                                    <strong>WiFi credentials sent!</strong>
                                </div>
                                <div style="background: #243352; border: 2px solid #4fb28e; border-radius: 8px; padding: 16px; margin-top: 12px;">
                                    <p style="color: #f1f5f9; margin-bottom: 8px;"><strong>Phase 2: Check your display</strong></p>
                                    <p style="color: #94a3b8; font-size: 13px;">Your device will refresh and show a <strong>6-character pairing code</strong>.</p>
                                    <p style="color: #94a3b8; font-size: 13px;">Enter it in the Phase 2 section below to complete setup.</p>
                                </div>
                            </div>
                        `;

                        // Disconnect BLE after success
                        setTimeout(() => {
                            if (bleServer && bleServer.connected) {
                                bleServer.disconnect();
                            }
                        }, 2000);

                        // Show and highlight the pairing code section
                        const pairingSection = document.getElementById('device-pairing-section');
                        const pairingDivider = document.getElementById('pairing-divider');
                        if (pairingSection) {
                            pairingSection.style.display = 'block';
                            pairingSection.style.border = '2px solid #4fb28e';
                            pairingSection.style.animation = 'pulse 1s ease-in-out 3';
                        }
                        if (pairingDivider) pairingDivider.style.display = 'block';

                        // Focus the pairing code input
                        setTimeout(() => {
                            const pairingInput = document.getElementById('device-pairing-code');
                            if (pairingInput) pairingInput.focus();
                        }, 500);
                    }
                });

                // HYBRID: Send WiFi credentials only (password triggers save in firmware)
                const encoder = new TextEncoder();
                await charSSID.writeValue(encoder.encode(ssid));
                statusDiv.innerHTML = '<span style="color: #667eea;">Sent WiFi network name...</span>';

                await charPassword.writeValue(encoder.encode(password));

                // Send server URL automatically (turnkey per Section 17.4)
                const serverUrl = window.location.origin;
                await charServer.writeValue(encoder.encode(serverUrl));
                console.log('[BLE] Server URL sent:', serverUrl);
                statusDiv.innerHTML = '<span style="color: #667eea;">Sent WiFi password... Device connecting to WiFi...</span>';

                // Wait for device to process and notify
                setTimeout(() => {
                    // If no notification received, show manual prompt
                    if (statusDiv.innerHTML.includes('Device connecting')) {
                        statusDiv.innerHTML = `
                            <div style="color: #22c55e; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
                                    <svg class="icon-sm"><use href="#icon-check-circle"/></svg>
                                    <strong>WiFi credentials sent!</strong>
                                </div>
                                <div style="background: #243352; border: 2px solid #4fb28e; border-radius: 8px; padding: 16px; margin-top: 12px;">
                                    <p style="color: #f1f5f9; margin-bottom: 8px;"><strong>Phase 2: Check your display</strong></p>
                                    <p style="color: #94a3b8; font-size: 13px;">Once WiFi connects, your device will refresh and show a <strong>6-character pairing code</strong>.</p>
                                    <p style="color: #94a3b8; font-size: 13px;">Enter it in the Phase 2 section below to complete setup.</p>
                                </div>
                            </div>
                        `;

                        // Show pairing section
                        const pairingSection = document.getElementById('device-pairing-section');
                        const pairingDivider = document.getElementById('pairing-divider');
                        if (pairingSection) pairingSection.style.display = 'block';
                        if (pairingDivider) pairingDivider.style.display = 'block';
                    }
                }, 5000);

            } catch (error) {
                console.error('[BLE] Error:', error);

                let errorMessage = 'Connection failed. ';
                if (error.name === 'NotFoundError') {
                    errorMessage = 'No device selected. Make sure your display shows "DEVICE SETUP" screen.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Bluetooth access denied. Please allow Bluetooth access and try again.';
                } else if (error.name === 'NetworkError') {
                    errorMessage = 'Connection lost. Please try again.';
                } else {
                    errorMessage += error.message || 'Please try again.';
                }

                statusDiv.innerHTML = `<span style="color: #f87171;">${errorMessage}</span>`;
            } finally {
                // Re-enable button
                connectBtn.disabled = false;
                connectBtn.style.opacity = '1';
            }
        }
        window.sendBLECredentials = sendBLECredentials;

        // Build webhook URL from current config
        function buildWebhookUrl() {
            // Get values from the form
            const state = detectedState || document.getElementById('state-select')?.value || 'VIC';
            const apiKey = document.getElementById('transit-api-key')?.value?.trim() || '';
            const homeAddress = document.getElementById('home-address')?.value?.trim() || '';
            const workAddress = document.getElementById('work-address')?.value?.trim() || '';
            const cafeAddress = document.getElementById('cafe-address')?.value?.trim() || '';
            const arrivalTime = document.getElementById('arrival-time')?.value || '09:00';
            const coffeeEnabled = document.getElementById('coffee-toggle')?.checked !== false;

            // Config is already saved to KV storage by setup wizard
            // Device fetches from /api/screen which reads from KV
            // This ensures device output matches the /api/screen PNG preview
            const baseUrl = window.location.origin;
            // NOTE: Do NOT append ?format=bmp - firmware adds it automatically
            return `${baseUrl}/api/screen`;
        }

        // Save and Test Google Places API Key (Step 1)
        window.saveAndTestGoogleKey = async function() {
            const apiKey = document.getElementById('google-places-api-key').value.trim();
            const btn = document.getElementById('save-api-key-btn');
            const status = document.getElementById('api-key-status');
            const nextBtn = document.getElementById('step-2-next-btn');

            if (!apiKey) {
                status.style.display = 'block';
                status.style.color = '#e53e3e';
                status.innerHTML = '<svg class="icon-sm"><use href="#icon-warning"/></svg> Please enter an API key';
                return;
            }

            // Disable button during save
            btn.disabled = true;
            btn.innerHTML = '<svg class="icon-sm"><use href="#icon-save"/></svg> Saving and Testing...';
            status.style.display = 'block';
            status.style.color = '#718096';
            status.innerHTML = '⏳ Saving and testing API key...';
            nextBtn.style.display = 'none';

            try {
                const response = await fetch('/api/save-google-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: apiKey })
                });

                const result = await response.json();

                if (result.success && result.saved) {
                    // Store validated key in localStorage for use in address searches
                    localStorage.setItem('cc-google-places-key', apiKey);
                    localStorage.setItem('cc-google-places-validated', 'true');
                    console.log('✅ Google key saved to localStorage for address searches');
                    
                    status.style.color = '#48bb78';
                    status.innerHTML = `<svg class="icon-sm" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> API key saved and validated! Google Places is working.<br><small style="color: #718096;">${result.testResult?.predictions || 0} test predictions returned</small>`;
                    btn.innerHTML = '<svg class="icon-sm" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> Saved & Tested';
                    btn.style.background = '#48bb78';

                    // Show the Next button
                    nextBtn.style.display = 'block';

                    // Re-enable autocomplete with new API key
                    console.log('Google Places API key activated, available services:', result.availableServices);
                } else if (result.success && !result.saved) {
                    // Validation failed - key NOT saved
                    status.style.color = '#e53e3e';
                    status.innerHTML = `<svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> API key validation failed - NOT saved:<br><small>${result.testResult?.message || 'Unknown error'}</small><br><small>Check your Google Cloud Console - ensure Places API (New) is enabled.</small>`;
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test API Key';
                    return;
                } else {
                    status.style.color = '#e53e3e';
                    status.innerHTML = `<svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> Failed to save: ${result.message}`;
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test API Key';
                }
            } catch (error) {
                status.style.color = '#e53e3e';
                status.innerHTML = `<svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> Error: ${error.message}`;
                btn.disabled = false;
                btn.innerHTML = '<svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test API Key';
            }
        };

        window.skipGoogleKey = function() {
            const warning = document.getElementById('skip-warning');
            const nextBtn = document.getElementById('step-2-next-btn');
            const status = document.getElementById('api-key-status');

            // Show warning
            warning.style.display = 'block';
            status.style.display = 'none';

            // Show the Next button immediately
            nextBtn.style.display = 'block';
            nextBtn.innerHTML = 'Continue Without API Key →';
            nextBtn.style.background = '#f59e0b';

            console.log('User chose to skip Google Places API key');
        };

        // Step 1: Device section visibility toggle
        window.updateDeviceSection = function() {
            const select = document.getElementById('device-select');
            const deviceInfo = document.getElementById('device-info-panel');
            const wifiSection = document.getElementById('wifi-provision-section');
            const factoryReset = document.getElementById('factory-reset-section');
            const webOnlyInfo = document.getElementById('web-only-info');
            const device = select.value;

            if (device && device.startsWith('trmnl')) {
                // TRMNL device selected - show WiFi provisioning
                deviceInfo.style.display = 'block';
                wifiSection.style.display = 'block';
                factoryReset.style.display = 'block';
                webOnlyInfo.style.display = 'none';
                localStorage.setItem('cc-device', device);
            } else if (device && device.startsWith('kindle')) {
                // Kindle selected - no WiFi provisioning needed
                deviceInfo.style.display = 'block';
                wifiSection.style.display = 'none';
                factoryReset.style.display = 'none';
                webOnlyInfo.style.display = 'none';
                localStorage.setItem('cc-device', device);
            } else {
                // No device - web only
                deviceInfo.style.display = 'none';
                wifiSection.style.display = 'none';
                factoryReset.style.display = 'none';
                webOnlyInfo.style.display = 'block';
                localStorage.removeItem('cc-device');
            }
        };

        // Factory reset via BLE (HYBRID: clears WiFi credentials, device clears URL on reset)
        window.factoryResetDevice = async function() {
            const status = document.getElementById('reset-status');
            status.innerHTML = '<span style="color: #f59e0b;">Searching for device...</span>';

            if (!navigator.bluetooth) {
                status.innerHTML = '<span style="color: #ef4444;">Bluetooth not supported. Use Chrome or Edge.</span>';
                return;
            }

            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'CommuteCompute' }],
                    optionalServices: [BLE_SERVICE_UUID]
                });

                status.innerHTML = '<span style="color: #f59e0b;">Connecting...</span>';
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BLE_SERVICE_UUID);

                // Send reset command to clear WiFi credentials
                // NOTE: URL characteristic removed in v7.1 - device firmware clears all settings on __RESET__
                const charSSID = await service.getCharacteristic(BLE_CHAR_SSID_UUID);
                const charPassword = await service.getCharacteristic(BLE_CHAR_PASSWORD_UUID);
                const charServer = await service.getCharacteristic(BLE_CHAR_SERVER_UUID);

                const encoder = new TextEncoder();
                await charSSID.writeValue(encoder.encode('__RESET__'));
                await charPassword.writeValue(encoder.encode(''));

                status.innerHTML = '<span style="color: #22c55e;">Device reset! It will restart and show DEVICE SETUP screen.</span>';
                server.disconnect();
            } catch (error) {
                status.innerHTML = `<span style="color: #ef4444;">Reset failed: ${error.message}</span>`;
            }
        };

        // Progressive save helper - saves to KV at each step (Zero-Config compliant)
        async function progressiveSave(data) {
            try {
                const baseUrl = window.location.origin;
                await fetch(baseUrl + '/api/sync-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log('[Setup] Progressive save:', Object.keys(data));
            } catch (e) {
                console.warn('[Setup] Progressive save failed (non-critical):', e.message);
            }
        }

        window.nextStep = async function(step) {
            if (step === 1) {
                // Step 1: Device Setup - save device selection
                const device = document.getElementById('device-select')?.value || '';
                if (device) {
                    localStorage.setItem('cc-device', device);
                }
            } else if (step === 2) {
                // Step 2: Google API Key - already saved by saveGoogleKey()
            } else if (step === 3) {
                // Step 3: Addresses - validate and save progressively
                const home = document.getElementById('home-address').value;
                const work = document.getElementById('work-address').value;

                if (!home || !work) {
                    alert('Please enter both home and work addresses');
                    return;
                }

                addresses = {
                    home,
                    work,
                    cafe: document.getElementById('cafe-address').value
                };

                // Progressive save addresses to KV
                await progressiveSave({
                    preferences: { addresses }
                });
                localStorage.setItem('cc-addresses', JSON.stringify(addresses));

                // Show authorities
                showAuthorities();
            } else if (step === 4) {
                // Step 4: Transit Authority - validate and save progressively
                if (!selectedAuthority) {
                    alert('Please select a transit authority');
                    return;
                }

                // Progressive save state to KV
                await progressiveSave({ state: selectedAuthority });
                localStorage.setItem('cc-state', selectedAuthority);

                showAPIForm();
            }

            document.getElementById(`step-${step}`).classList.remove('active');
            document.getElementById(`step-${step + 1}`).classList.add('active');
            document.getElementById(`step-${step}-indicator`).classList.add('completed');
            document.getElementById(`step-${step}-indicator`).classList.remove('active');
            document.getElementById(`step-${step + 1}-indicator`).classList.add('active');
            currentStep = step + 1;
        };

        window.previousStep = function(step) {
            document.getElementById(`step-${step}`).classList.remove('active');
            document.getElementById(`step-${step - 1}`).classList.add('active');
            document.getElementById(`step-${step - 1}-indicator`).classList.remove('completed');
            document.getElementById(`step-${step}-indicator`).classList.remove('active');
            document.getElementById(`step-${step - 1}-indicator`).classList.add('active');
            currentStep = step - 1;
        };

        function showAuthorities() {
            const list = document.getElementById('authority-list');
            let html = '';

            Object.entries(AUTHORITIES).forEach(([code, auth]) => {
                const isDetected = code === detectedState;
                html += `
                    <div class="authority-card ${isDetected ? 'selected' : ''}" onclick="selectAuthority('${code}')">
                        <div class="authority-name">${auth.name} ${isDetected ? '<svg class="icon-sm" style="color: #22c55e;"><use href="#icon-check-circle"/></svg>' : ''}</div>
                        <div class="authority-desc">${auth.state}</div>
                        <a href="${auth.url}" target="_blank" class="authority-link">Register for API →</a>
                    </div>
                `;
            });

            list.innerHTML = html;
            if (detectedState) {
                selectedAuthority = detectedState;
            }
        }

        window.selectAuthority = function(code) {
            selectedAuthority = code;
            document.querySelectorAll('.authority-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        };

        function showAPIForm() {
            const auth = AUTHORITIES[selectedAuthority];
            document.getElementById('api-info').innerHTML = `
                <strong style="color: #e2e8f0;">Get ${auth.name} API Key</strong><br>
                <span style="color: #a0aec0;">Visit: <a href="${auth.url}" target="_blank" style="color: #4fb28e;">${auth.url}</a></span>
            `;

            let html = '';
            if (selectedAuthority === 'VIC') {
                html = `
                    <div class="form-group">
                        <label class="form-label" style="color: #e2e8f0;">Transport Victoria OpenData API Key</label>
                        <input type="text" id="api-key" class="form-input" placeholder="Enter your API key" autocomplete="off" inputmode="text" style="-webkit-text-security: disc;">
                        <small style="color: #a0aec0; margin-top: 5px; display: block;">
                            Register at <a href="https://opendata.transport.vic.gov.au/" target="_blank" style="color: #4fb28e;">opendata.transport.vic.gov.au</a> — Subscribe to GTFS Realtime feeds
                        </small>
                    </div>
                `;
            } else {
                html = `
                    <div class="form-group">
                        <label class="form-label" style="color: #e2e8f0;">${auth.name} API Key</label>
                        <input type="text" id="api-key" class="form-input" placeholder="Your API Key" autocomplete="off" inputmode="text" style="-webkit-text-security: disc;">
                        <small style="color: #a0aec0; margin-top: 5px; display: block;">
                            Register at <a href="${auth.url}" target="_blank" style="color: #4fb28e;">${auth.url}</a>
                        </small>
                    </div>
                `;
            }

            document.getElementById('api-credentials-form').innerHTML = html;
        }

        // Save and validate Transit API key (like Google key)
        window.saveAndTestTransitKey = async function() {
            const apiKey = document.getElementById('api-key')?.value?.trim();
            const btn = document.getElementById('save-transit-key-btn');
            const status = document.getElementById('transit-api-status');
            const skipBtn = document.getElementById('skip-transit-btn');

            if (!status) {
                console.error('transit-api-status element not found');
                return;
            }

            if (!apiKey) {
                status.style.display = 'block';
                status.innerHTML = '<span style="color: #e53e3e;"><svg class="icon-sm"><use href="#icon-warning"/></svg> Please enter an API key or click "Skip for Now"</span>';
                return;
            }

            btn.disabled = true;
            btn.textContent = '⏳ Validating...';
            status.style.display = 'block';
            status.innerHTML = '<span style="color: #a0aec0;"><svg class="icon-sm"><use href="#icon-refresh"/></svg> Testing API key...</span>';

            try {
                // Add timeout for slow API validation
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
                
                const response = await fetch('/api/save-transit-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, state: selectedAuthority || 'VIC' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                const result = await response.json();

                if (result.success && result.testResult?.success) {
                    // Store in localStorage like Google key
                    localStorage.setItem('cc-transit-api-key', apiKey);
                    localStorage.setItem('cc-transit-api-validated', 'true');
                    localStorage.setItem('cc-transit-state', selectedAuthority);

                    status.innerHTML = `<span style="color: #48bb78;"><svg class="icon-sm"><use href="#icon-check-circle"/></svg> API key saved and validated! Real-time data enabled.</span>`;
                    btn.innerHTML = '<svg class="icon-sm" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> Saved & Tested';
                    btn.style.background = '#48bb78';
                    if (skipBtn) skipBtn.style.display = 'none';
                } else {
                    status.innerHTML = `<span style="color: #e53e3e;"><svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> Validation failed: ${result.testResult?.message || result.message || 'Unknown error'}</span><br><small style="color: #a0aec0;">Check your key and try again, or skip to use timetable fallback.</small>`;
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test';
                }
            } catch (error) {
                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timed out. The API may be slow - try again or skip.';
                }
                status.innerHTML = `<span style="color: #e53e3e;"><svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> Error: ${errorMsg}</span>`;
                btn.disabled = false;
                btn.innerHTML = '<svg class="icon-sm"><use href="#icon-save"/></svg> Save & Test';
            }
        };

        // Skip transit API key - use timetable fallback
        window.skipTransitKey = function() {
            const status = document.getElementById('transit-api-status');

            if (!status) {
                console.error('transit-api-status element not found');
                return;
            }

            // Clear any stored transit key
            localStorage.removeItem('cc-transit-api-key');
            localStorage.removeItem('cc-transit-api-validated');
            localStorage.setItem('cc-transit-fallback', 'timetable');
            localStorage.setItem('cc-transit-state', selectedAuthority);

            status.style.display = 'block';
            status.innerHTML = '<span style="color: #f6ad55;"><svg class="icon-sm"><use href="#icon-warning"/></svg> Using timetable fallback. You can add an API key later in Settings.</span>';
        };

        window.completeSetup = async function() {
            let lastStep = 'init';
            
            // Immediately show fallback navigation and hide setup buttons
            const manualNav = document.getElementById('manual-navigation');
            const setupButtons = document.getElementById('setup-buttons');
            if (manualNav) manualNav.style.display = 'block';
            if (setupButtons) setupButtons.style.display = 'none';
            
            // Show processing status
            document.getElementById('setup-status').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="color: #4fb28e; font-size: 18px; margin-bottom: 10px;">⏳ Processing setup...</div>
                    <p style="color: #94a3b8;">Saving your configuration</p>
                </div>
            `;
            
            try {
                lastStep = 'getting arrival time';
                const arrivalTime = document.getElementById('arrival-time').value;
                
                lastStep = 'building config';
                const config = {
                    addresses: addresses,
                    authority: selectedAuthority,
                    arrivalTime: arrivalTime,
                    includeCoffee: document.getElementById('include-coffee').checked,
                    credentials: {
                        apiKey: document.getElementById('api-key')?.value || localStorage.getItem('cc-transit-api-key') || ''
                    }
                };

                lastStep = 'getting baseUrl';
                // Use absolute URL to avoid iOS Safari relative URL issues
                const baseUrl = window.location.origin;
                
                lastStep = 'fetching setup/complete';
                
                // Save configuration (use /api path for Vercel serverless)
                const response = await fetch(baseUrl + '/api/admin/setup-complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                lastStep = 'parsing response JSON';
                const result = await response.json();
                
                lastStep = 'checking result.success';

                if (result.success) {
                    // Get API mode (cached = free, live = uses Google API at runtime)
                    const apiMode = document.querySelector('input[name="api-mode"]:checked')?.value || 'cached';
                    const googleKey = document.getElementById('google-places-api-key')?.value || '';
                    const includeCoffee = document.getElementById('include-coffee').checked;
                    
                    // Cache cafe details during setup (one-time API call) if cafe address provided
                    let cafeData = null;
                    if (includeCoffee && addresses.cafe && result.locations?.cafe) {
                        lastStep = 'caching cafe details';
                        try {
                            const cafeResponse = await fetch(baseUrl + '/api/cafe-details', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    lat: result.locations.cafe.lat,
                                    lon: result.locations.cafe.lon,
                                    cafeName: addresses.cafe,
                                    googleKey: googleKey
                                })
                            });
                            const cafeResult = await cafeResponse.json();
                            if (cafeResult.success) {
                                cafeData = cafeResult.cafe;
                                console.log('Cached cafe data:', cafeData);
                            }
                        } catch (cafeError) {
                            console.warn('Could not cache cafe details:', cafeError);
                        }
                    }
                    
                    // Get selected device (optional - empty means web-only)
                    const selectedDevice = document.getElementById('device-select')?.value || '';
                    
                    // Generate webhook URL for TRMNL device
                    // All location data is cached here - no runtime API calls needed for basic functionality
                    const fullConfig = {
                        addresses: addresses,
                        journey: {
                            transitRoute: result.transitRoute || {},
                            arrivalTime: document.getElementById('arrival-time').value,
                            coffeeEnabled: includeCoffee
                        },
                        locations: result.locations || {},
                        state: selectedAuthority,
                        api: { key: document.getElementById('api-key')?.value || '' },
                        // Cafe data cached from setup - no runtime API calls
                        cafe: cafeData,
                        // API mode: 'cached' (free) or 'live' (uses Google API)
                        apiMode: apiMode,
                        // E-ink device selection (optional)
                        device: selectedDevice
                    };
                    
                    // Save config to localStorage FIRST (before webhook generation)
                    localStorage.setItem('cc-config', JSON.stringify(fullConfig));
                    localStorage.setItem('cc-configured', 'true');
                    // Also save device separately for quick access
                    if (selectedDevice) {
                        localStorage.setItem('cc-device', selectedDevice);
                    }
                    
                    // Per Section 3.6 & 11.8: Sync config to Vercel KV for server-side access
                    try {
                        lastStep = 'syncing to KV';
                        const transitKey = document.getElementById('api-key')?.value || localStorage.getItem('cc-transit-api-key') || '';
                        const googleKey = document.getElementById('google-places-api-key')?.value || localStorage.getItem('cc-google-api-key') || '';
                        
                        const syncResponse = await fetch(baseUrl + '/api/sync-config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                transitKey: transitKey,
                                googleKey: googleKey,
                                state: selectedAuthority,
                                preferences: fullConfig
                            })
                        });
                        const syncResult = await syncResponse.json();
                        console.log('[Setup] KV sync result:', syncResult);
                        
                        if (syncResult.kv?.available) {
                            console.log('[Setup] ✅ Config synced to Vercel KV');
                        } else {
                            console.log('[Setup] ⚠️ KV not available, using localStorage fallback');
                        }
                    } catch (syncError) {
                        console.warn('[Setup] KV sync failed (non-critical):', syncError);
                    }
                    
                    let webhookHtml = '';
                    let webhookUrl = '';
                    
                    // Try to generate webhook URL (optional - config already saved)
                    try {
                        lastStep = 'fetching generate-webhook';
                        const webhookResponse = await fetch(baseUrl + '/api/admin/generate-webhook', { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ config: fullConfig })
                        });
                        
                        const webhookResult = await webhookResponse.json();
                        
                        if (webhookResult.success) {
                            webhookUrl = webhookResult.webhookUrl;
                            localStorage.setItem('cc-webhook-url', webhookUrl);
                            
                            webhookHtml = `
                                <div style="margin-top: 20px; padding: 15px; background: rgba(79, 178, 142, 0.1); border-radius: 8px; border: 1px solid rgba(79, 178, 142, 0.3);">
                                    <h4 style="color: #4fb28e; margin-bottom: 10px;"><svg class="icon-sm"><use href="#icon-link"/></svg> Your Device Webhook URL:</h4>
                                    <input type="text" value="${webhookUrl}" readonly 
                                        style="width: 100%; padding: 10px; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #f1f5f9;"
                                        onclick="this.select(); document.execCommand('copy'); alert('Copied!');">
                                    <p style="color: #94a3b8; font-size: 12px; margin-top: 10px;">
                                        1. Copy this URL<br>
                                        2. Flash custom firmware to your e-ink device<br>
                                        3. Configure device to use this webhook URL<br>
                                        4. Your display will show live transit data!
                                    </p>
                                </div>
                            `;
                        }
                    } catch (webhookError) {
                        console.warn('Webhook generation failed (non-critical):', webhookError);
                        // Continue anyway - config is saved, webhook can be generated later
                    }
                    
                    // Hide the form elements and button row after success
                    const form = document.querySelector('#step-5 form');
                    if (form) {
                        form.style.display = 'none';
                    }
                    
                    // Store webhook URL for device pairing
                    window.generatedWebhookUrl = webhookUrl;
                    window.fullConfig = fullConfig;

                    // Check if pairing code was entered in device section
                    const pairingCodeInput = document.getElementById('device-pairing-code');
                    const pairingCode = pairingCodeInput?.value?.trim()?.toUpperCase() || '';
                    const hasValidPairingCode = pairingCode.length === 6 && /^[A-Z0-9]{6}$/.test(pairingCode);

                    // Build completion HTML based on whether we have a pairing code
                    let pairingHtml = '';
                    if (hasValidPairingCode) {
                        pairingHtml = `
                            <div id="auto-pairing-status" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.25) 0%, rgba(34, 197, 94, 0.2) 100%); border: 3px solid #4fb28e; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                                    <div class="spinner" style="width: 24px; height: 24px; border: 3px solid rgba(79, 178, 142, 0.3); border-top-color: #4fb28e; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <span style="color: #22c55e; font-weight: 600; font-size: 16px;">Pairing with display ${pairingCode}...</span>
                                </div>
                            </div>
                        `;
                    } else if (selectedDevice && selectedDevice.startsWith('trmnl')) {
                        // Device selected but no code - show pairing input
                        pairingHtml = `
                            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(79, 178, 142, 0.25) 0%, rgba(34, 197, 94, 0.2) 100%); border: 3px solid #4fb28e; border-radius: 12px;">
                                <h4 style="color: #22c55e; margin-bottom: 12px; font-size: 16px;">Pair Your Display</h4>
                                <p style="color: #f1f5f9; font-size: 13px; margin-bottom: 12px;">Enter the 6-character code shown on your display:</p>
                                <div style="display: flex; gap: 10px; align-items: center; max-width: 350px; margin: 0 auto;">
                                    <input type="text" id="device-code" placeholder="A7X9K2" maxlength="6"
                                        style="flex: 1; padding: 14px; font-size: 20px; font-family: monospace; text-transform: uppercase; letter-spacing: 5px; text-align: center; background: rgba(0,0,0,0.3); border: 2px solid #4fb28e; border-radius: 8px; color: #f1f5f9; font-weight: bold;"
                                        oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6)">
                                    <button type="button" onclick="pairDevice()" id="pair-btn" style="padding: 14px 24px; background: #4fb28e; border: none; border-radius: 8px; color: #1a2744; font-weight: 700; cursor: pointer;">Pair</button>
                                </div>
                                <div id="pairing-status" style="margin-top: 10px; font-size: 13px; text-align: center;"></div>
                                <p style="color: #94a3b8; font-size: 11px; margin-top: 10px; text-align: center;">
                                    <a href="#" onclick="skipPairing(); return false;" style="color: #4fb28e;">Skip pairing</a>
                                </p>
                            </div>
                        `;
                    }

                    document.getElementById('setup-status').innerHTML = `
                        <div class="success-box" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); padding: 20px; border-radius: 12px;">
                            <h3 style="color: #22c55e; margin-bottom: 10px;"><svg class="icon"><use href="#icon-check-circle"/></svg> Setup Complete!</h3>
                            <p style="color: #86efac;">Your intelligent transit display is ready.</p>

                            ${pairingHtml}

                            ${webhookHtml}

                            <div id="redirect-section" style="${hasValidPairingCode || !selectedDevice || !selectedDevice.startsWith('trmnl') ? '' : 'display: none;'} margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <p style="color: #22c55e; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Directing you to your dashboard now...</p>
                                <p style="color: #a3b8d0; font-size: 13px; margin-bottom: 10px;">Redirecting in <span id="redirect-countdown">5</span> seconds</p>
                                <button type="button" class="btn" onclick="window.location.href='/admin.html'" style="width: 100%; background: #4fb28e; border: none; color: #1a2744;">Go to Dashboard Now →</button>
                            </div>
                        </div>
                        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
                    `;

                    // If we have a valid pairing code, automatically pair
                    if (hasValidPairingCode) {
                        autoPairDevice(pairingCode, webhookUrl, fullConfig);
                    } else if (!selectedDevice || !selectedDevice.startsWith('trmnl')) {
                        // No device or non-pairing device - start redirect
                        startRedirectCountdown();
                    } else {
                        // Device selected but no code - focus on input
                        setTimeout(() => {
                            const codeInput = document.getElementById('device-code');
                            if (codeInput) codeInput.focus();
                        }, 100);
                    }
                    setTimeout(() => {
                        const codeInput = document.getElementById('device-code');
                        if (codeInput) codeInput.focus();
                    }, 100);
                } else {
                    alert('Setup failed: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Setup error:', e);
                alert('Error at [' + lastStep + ']: ' + e.message);
            }
        };

        // Device pairing function
        async function pairDevice() {
            const codeInput = document.getElementById('device-code');
            const statusDiv = document.getElementById('pairing-status');
            const pairBtn = document.getElementById('pair-btn');
            const code = codeInput.value.trim().toUpperCase();

            if (!code || code.length < 4) {
                statusDiv.innerHTML = '<span style="color: #f87171;">Please enter the 6-character code from your display</span>';
                codeInput.focus();
                return;
            }

            // Disable button during pairing
            if (pairBtn) {
                pairBtn.disabled = true;
                pairBtn.textContent = '...';
            }
            statusDiv.innerHTML = '<span style="color: #4fb28e;">Pairing with your display...</span>';

            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/pair/${code}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        webhookUrl: window.generatedWebhookUrl,
                        config: window.fullConfig
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div style="color: #22c55e; font-weight: 600; font-size: 16px;">
                            <svg class="icon" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> Display Paired Successfully!
                        </div>
                        <p style="color: #86efac; font-size: 13px; margin-top: 8px;">
                            Your display will show your commute within 30 seconds.
                        </p>
                    `;
                    codeInput.disabled = true;
                    if (pairBtn) pairBtn.style.display = 'none';

                    // Show redirect section and start countdown
                    startRedirectCountdown();
                } else {
                    statusDiv.innerHTML = `<span style="color: #f87171;"><svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> ${result.error || 'Pairing failed. Check the code and try again.'}</span>`;
                    if (pairBtn) {
                        pairBtn.disabled = false;
                        pairBtn.textContent = 'Pair';
                    }
                    codeInput.focus();
                    codeInput.select();
                }
            } catch (error) {
                console.error('Pairing error:', error);
                statusDiv.innerHTML = `<span style="color: #f87171;"><svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> Connection error. Check your internet and try again.</span>`;
                if (pairBtn) {
                    pairBtn.disabled = false;
                    pairBtn.textContent = 'Pair';
                }
            }
        }

        // Skip pairing and go to dashboard
        function skipPairing() {
            startRedirectCountdown();
        }

        // Start redirect countdown
        function startRedirectCountdown() {
            const redirectSection = document.getElementById('redirect-section');
            if (redirectSection) redirectSection.style.display = 'block';

            let countdown = 5;
            const countdownEl = document.getElementById('redirect-countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownEl) countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = '/admin.html';
                }
            }, 1000);
        }

        // Auto-pair device (when code entered in device selection step)
        async function autoPairDevice(code, webhookUrl, config) {
            const statusDiv = document.getElementById('auto-pairing-status');

            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/pair/${code}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        webhookUrl: webhookUrl,
                        config: config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="color: #22c55e; font-weight: 700; font-size: 18px; margin-bottom: 8px;">
                                <svg class="icon" style="color: #22c55e;"><use href="#icon-check-circle"/></svg> Display Paired!
                            </div>
                            <p style="color: #86efac; font-size: 14px;">
                                Your display will show your commute within 30 seconds.
                            </p>
                        </div>
                    `;
                    // Start redirect after successful pairing
                    setTimeout(() => startRedirectCountdown(), 1500);
                } else {
                    statusDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="color: #f87171; font-weight: 600; margin-bottom: 8px;">
                                <svg class="icon-sm" style="color: #f87171;"><use href="#icon-x-circle"/></svg> Pairing failed: ${result.error || 'Unknown error'}
                            </div>
                            <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">
                                Check the code matches your display and try again.
                            </p>
                            <div style="display: flex; gap: 10px; align-items: center; max-width: 300px; margin: 0 auto;">
                                <input type="text" id="device-code" value="${code}" maxlength="6"
                                    style="flex: 1; padding: 12px; font-size: 18px; font-family: monospace; text-transform: uppercase; letter-spacing: 4px; text-align: center; background: rgba(0,0,0,0.3); border: 2px solid #f87171; border-radius: 8px; color: #f1f5f9; font-weight: bold;"
                                    oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6)">
                                <button type="button" onclick="pairDevice()" style="padding: 12px 20px; background: #4fb28e; border: none; border-radius: 8px; color: #1a2744; font-weight: 700; cursor: pointer;">Retry</button>
                            </div>
                            <div id="pairing-status" style="margin-top: 8px;"></div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Auto-pairing error:', error);
                statusDiv.innerHTML = `
                    <div style="text-align: center; color: #f87171;">
                        <svg class="icon-sm"><use href="#icon-x-circle"/></svg> Connection error. Try manually pairing below.
                    </div>
                `;
                startRedirectCountdown();
            }
        }

        window.pairDevice = pairDevice;
        window.skipPairing = skipPairing;
        window.autoPairDevice = autoPairDevice;

        // Load version info
        function loadVersionInfo() {
            fetch('/api/version')
                .then(r => r.json())
                .then(v => {
                    const version = v.components?.setupWizard?.version || 'v1.5.0';
                    const systemVersion = v.system?.version || '1.0.0';
                    document.getElementById('versionHash').textContent = `${version} (System ${systemVersion})`;
                    document.getElementById('buildDate').textContent = v.date || new Date().toISOString().split('T')[0];
                })
                .catch(() => {
                    document.getElementById('versionHash').textContent = 'v1.5.0';
                    document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
                });
        }

        // Factory Reset - Wipes all configuration, KV storage, and local storage
        window.performFactoryReset = async function() {
            const btn = document.getElementById('factory-reset-btn');
            const status = document.getElementById('factory-reset-status');
            
            // Confirm with user
            if (!confirm('⚠️ FACTORY RESET\n\nThis will permanently delete:\n• All API keys (Google, Transit)\n• All saved addresses\n• Device pairings\n• Local cached data\n\nYou will need to reconfigure everything.\n\nAre you sure?')) {
                return;
            }
            
            // Double confirm
            if (!confirm('This action cannot be undone.\n\nClick OK to proceed with factory reset.')) {
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<svg class="icon-sm"><use href="#icon-trash"/></svg> Resetting...';
            status.style.display = 'block';
            status.style.color = '#94a3b8';
            status.innerHTML = '⏳ Clearing local storage...';
            
            const results = { local: false, kv: false, errors: [] };
            
            try {
                // Step 1: Clear all localStorage
                const localKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('cc-') || key.startsWith('commute-') || key.includes('transit') || key.includes('google'))) {
                        localKeys.push(key);
                    }
                }
                localKeys.forEach(key => localStorage.removeItem(key));
                // Also clear any session storage
                sessionStorage.clear();
                results.local = true;
                console.log('[Factory Reset] Cleared local storage:', localKeys);
                
                status.innerHTML = '⏳ Clearing server storage (KV)...';
                
                // Step 2: Call server reset API
                try {
                    const response = await fetch('/api/admin/reset?confirm=yes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        results.kv = true;
                        console.log('[Factory Reset] KV storage cleared:', data.deleted);
                    } else {
                        // KV might not be configured, that's OK
                        console.warn('[Factory Reset] KV clear warning:', data.error);
                        results.errors.push('KV: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.warn('[Factory Reset] KV API error:', e.message);
                    results.errors.push('KV API: ' + e.message);
                }
                
                // Step 3: Show results and reload
                status.style.color = '#4fb28e';
                let message = '✅ Factory reset complete!<br><small style="color: #94a3b8;">';
                message += `Local storage: ${results.local ? 'cleared' : 'failed'}<br>`;
                message += `Server storage: ${results.kv ? 'cleared' : 'skipped (not configured)'}</small>`;
                
                if (results.errors.length > 0) {
                    message += `<br><small style="color: #f59e0b;">Warnings: ${results.errors.join(', ')}</small>`;
                }
                
                status.innerHTML = message + '<br><br>Reloading page in 3 seconds...';
                
                // Reload page after delay
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
                
            } catch (error) {
                console.error('[Factory Reset] Error:', error);
                status.style.color = '#f87171';
                status.innerHTML = `❌ Reset failed: ${error.message}`;
                btn.disabled = false;
                btn.innerHTML = '<svg class="icon-sm"><use href="#icon-trash"/></svg> Factory Reset';
            }
        };

        // Wipe All Data - Complete reset of local and server storage
        window.wipeAllData = async function() {
            const btn = document.getElementById('wipe-all-data-btn');
            const status = document.getElementById('wipe-status');

            if (!confirm('⚠️ WIPE ALL DATA\n\nThis will permanently delete:\n• All saved addresses and journeys\n• All API keys (Google, Transit)\n• All device pairings\n• All local browser cache\n• All server-side data (Vercel KV)\n\nYou will need to reconfigure everything from scratch.\n\nAre you sure?')) {
                return;
            }

            if (!confirm('⚠️ FINAL WARNING\n\nThis action cannot be undone.\n\nClick OK to permanently delete all data.')) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '⏳ Wiping...';
            status.style.color = '#94a3b8';
            status.innerHTML = 'Clearing local storage...';

            const results = { local: 0, session: false, kv: false, errors: [] };

            try {
                // Step 1: Clear ALL localStorage (not just prefixed keys)
                const localCount = localStorage.length;
                localStorage.clear();
                results.local = localCount;
                console.log('[Wipe] Cleared localStorage:', localCount, 'items');

                // Step 2: Clear sessionStorage
                sessionStorage.clear();
                results.session = true;
                console.log('[Wipe] Cleared sessionStorage');

                status.innerHTML = 'Clearing server storage (Vercel KV)...';

                // Step 3: Clear Vercel KV storage
                try {
                    const response = await fetch('/api/admin/reset?confirm=yes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.success) {
                        results.kv = true;
                        console.log('[Wipe] KV storage cleared:', data.deleted);
                    } else {
                        results.errors.push('KV: ' + (data.error || 'Not configured'));
                    }
                } catch (e) {
                    console.warn('[Wipe] KV API error:', e.message);
                    results.errors.push('KV API: ' + e.message);
                }

                // Show results
                status.style.color = '#22c55e';
                let message = '✅ All data wiped successfully!<br>';
                message += `<small style="color: #94a3b8;">`;
                message += `Local storage: ${results.local} items cleared<br>`;
                message += `Session storage: cleared<br>`;
                message += `Server storage (KV): ${results.kv ? 'cleared' : 'skipped'}</small>`;

                if (results.errors.length > 0) {
                    message += `<br><small style="color: #fbbf24;">Notes: ${results.errors.join(', ')}</small>`;
                }

                status.innerHTML = message + '<br><br>Reloading in 3 seconds...';

                setTimeout(() => {
                    window.location.reload();
                }, 3000);

            } catch (error) {
                console.error('[Wipe] Error:', error);
                status.style.color = '#ef4444';
                status.innerHTML = `❌ Error: ${error.message}`;
                btn.disabled = false;
                btn.innerHTML = 'Wipe All Data';
            }
        };

        // Clear Local Storage Only (browser cache)
        window.clearLocalStorageOnly = function() {
            const status = document.getElementById('wipe-status');

            if (!confirm('Clear all browser cache for Commute Compute?\n\nThis will remove locally stored preferences and cached data.\nServer-side data will remain intact.')) {
                return;
            }

            try {
                const count = localStorage.length;
                localStorage.clear();
                sessionStorage.clear();

                status.style.color = '#22c55e';
                status.innerHTML = `✅ Browser cache cleared (${count} items removed).<br><small style="color: #94a3b8;">Reloading...</small>`;

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } catch (error) {
                status.style.color = '#ef4444';
                status.innerHTML = `❌ Error: ${error.message}`;
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupAddressAutocomplete('home-address', 'home-suggestions');
            setupAddressAutocomplete('work-address', 'work-suggestions');
            setupAddressAutocomplete('cafe-address', 'cafe-suggestions');
            loadVersionInfo();
        });
    </script>
</body>
</html>
