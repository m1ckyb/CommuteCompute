<!DOCTYPE html>
<html lang="en">
<!--
    Commute Compute - Intelligent Transit Display System
    Copyright (c) 2026 Angus Bergman
    Licensed under AGPL v3
    /LICENCE
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commute Compute Dashboard - Live Transit Display</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #1a2744;
      color: #f1f5f9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      width: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 24px;
      color: #f1f5f9;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      color: #cbd5e1;
    }

    /* Main Dashboard - Exact 800×480 e-ink dimensions */
    .dashboard {
      width: 800px;
      height: 480px;
      background: white;
      border: 3px solid #333;
      position: relative;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      margin: 0 auto;
    }

    /* Station Name Box (Top Left) */
    .station-box {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 90px;
      height: 50px;
      border: 2px solid black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      letter-spacing: -0.5px;
      padding: 5px;
      text-align: center;
    }

    /* Large Time Display (Top Center) */
    .time {
      position: absolute;
      top: 15px;
      left: 140px;
      font-size: 36px;
      font-weight: bold;
      letter-spacing: 2px;
    }

    /* Section Headers (Black Strips) */
    .section-header {
      position: absolute;
      height: 25px;
      background: black;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .tram-header {
      top: 120px;
      left: 10px;
      width: 370px;
    }

    .train-header {
      top: 120px;
      left: 400px;
      width: 360px;
    }

    /* Departure Labels (Next/Then) */
    .departure-label {
      position: absolute;
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    /* Departure Times (Large Numbers) */
    .departure {
      position: absolute;
      font-size: 28px;
      font-weight: bold;
    }

    /* Status Bar (Bottom Center) */
    .status {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    /* Weather (Right Sidebar) */
    .weather {
      position: absolute;
      right: 15px;
      top: 340px;
      font-size: 11px;
      text-align: right;
      max-width: 80px;
    }

    .temperature {
      position: absolute;
      right: 15px;
      top: 410px;
      font-size: 16px;
      text-align: right;
      font-weight: bold;
    }

    /* Info Panel (Below Dashboard) */
    .info {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .info h3 {
      font-size: 16px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .region {
      display: inline-block;
      margin: 5px;
      padding: 6px 12px;
      background: #edf2f7;
      border-radius: 6px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }

    .region strong {
      color: #2d3748;
    }

    .metadata {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e2e8f0;
      font-size: 13px;
      color: #4a5568;
    }

    .metadata p {
      margin: 5px 0;
    }

    /* Live indicator */
    .live-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #48bb78;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .refresh-timer {
      text-align: center;
      margin-top: 15px;
      font-size: 12px;
      color: #718096;
    }

    /* Responsive adjustments */
    @media (max-width: 850px) {
      .dashboard {
        transform: scale(0.9);
        transform-origin: top center;
      }
    }

    @media (max-width: 750px) {
      .dashboard {
        transform: scale(0.7);
      }
    }

    /* Version control footer */
    .version-footer {
      margin-top: 20px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      text-align: center;
      font-size: 11px;
      color: #718096;
      font-family: 'Courier New', monospace;
    }

    .version-footer .version-label {
      font-weight: 600;
      color: #4a5568;
      margin-right: 8px;
    }

    .version-footer .version-value {
      color: #2d3748;
    }

    .version-footer .separator {
      margin: 0 10px;
      color: #cbd5e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Commute Compute Dashboard Preview</h1>
      <p><span class="live-indicator"></span>Live visualization of 800×480 e-ink display</p>
    </div>

    <!-- Main Dashboard (Exact E-ink Dimensions) -->
    <div class="dashboard" id="dashboard">
      <!-- Station Name Box (Dynamic - configured via admin panel) -->
      <div class="station-box" id="station-name">STATION</div>

      <!-- Large Time -->
      <div class="time" id="time">--:--</div>

      <!-- Tram Section -->
      <div class="section-header tram-header" id="tram-header">TRAMS</div>
      <div class="departure-label" style="top: 152px; left: 20px;">Next:</div>
      <div class="departure" id="tram1" style="top: 170px; left: 20px;">-- min*</div>
      <div class="departure-label" style="top: 222px; left: 20px;">Then:</div>
      <div class="departure" id="tram2" style="top: 240px; left: 20px;">-- min*</div>

      <!-- Train Section -->
      <div class="section-header train-header" id="train-header">TRAINS</div>
      <div class="departure-label" style="top: 152px; left: 410px;">Next:</div>
      <div class="departure" id="train1" style="top: 170px; left: 410px;">-- min*</div>
      <div class="departure-label" style="top: 222px; left: 410px;">Then:</div>
      <div class="departure" id="train2" style="top: 240px; left: 410px;">-- min*</div>

      <!-- Weather (Right Sidebar) -->
      <div class="weather" id="weather">N/A</div>
      <div class="temperature" id="temperature">--°</div>

      <!-- Status Bar -->
      <div class="status">GOOD SERVICE</div>
    </div>

    <!-- Info Panel -->
    <div class="info">
      <h3>Region Data</h3>
      <div id="regionData">
        <span class="region"><strong>Loading...</strong></span>
      </div>

      <div class="metadata">
        <p><strong>Server:</strong> <span id="serverUrl">Connecting...</span></p>
        <p><strong>Last Update:</strong> <span id="lastUpdate">Never</span></p>
        <p><strong>Data Mode:</strong> <span id="dataMode">Unknown</span></p>
        <p><strong>Next Refresh:</strong> <span id="countdown">10</span>s</p>
      </div>
    </div>

    <div class="refresh-timer">
      Auto-refreshing every 10 seconds
    </div>

    <!-- Version Control Footer -->
    <div class="version-footer">
      <span class="version-label">Version:</span>
      <span class="version-value" id="versionHash">Loading...</span>
      <span class="separator">•</span>
      <span class="version-label">Build:</span>
      <span class="version-value" id="buildDate">Loading...</span>
      <span class="separator">•</span>
      <span class="version-value">© 2026 Angus Bergman</span>
    </div>

    <!-- Data Source Attributions -->
    <div id="attributions-footer" style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 10px; opacity: 0.7; line-height: 1.6; max-width: 800px; margin-left: auto; margin-right: auto;">
      <div style="font-weight: 600; margin-bottom: 6px; font-size: 11px;">Data Source Attributions</div>
      <div id="attributions-content">Loading...</div>
    </div>
  </div>

  <script>
    // Set version control info
    fetch('/api/version')
      .then(r => r.json())
      .then(v => {
        document.getElementById('versionHash').textContent = v.version || 'v2.5.0';
        document.getElementById('buildDate').textContent = v.date || new Date().toISOString().split('T')[0];
      })
      .catch(() => {
        document.getElementById('versionHash').textContent = 'v2.5.0';
        document.getElementById('buildDate').textContent = new Date().toISOString().split('T')[0];
      });

    // Load required attributions
    fetch('/api/attributions')
      .then(r => r.json())
      .then(data => {
        const content = document.getElementById('attributions-content');
        if (data.attributions && data.attributions.length > 0) {
          content.innerHTML = data.attributions.map(attr =>
            `<div style="margin-bottom: 3px;">• ${attr.text}</div>`
          ).join('');
        }
      })
      .catch(() => {
        document.getElementById('attributions-content').innerHTML = 'Created by Angus Bergman • AGPL v3';
      });
  </script>
  <script>
    // Configuration - Use current server
    const API_URL = '/api/region-updates';

    let countdown = 10;
    let countdownInterval;

    // Fetch and update dashboard
    async function updateDashboard() {
      try {
        console.log('Fetching data from:', API_URL);
        const response = await fetch(API_URL);
        const data = await response.json();

        console.log('Data received:', data);

        // Update dashboard elements
        const regions = data.regions;

        // Update each region
        const timeRegion = regions.find(r => r.id === 'time');
        if (timeRegion) document.getElementById('time').textContent = timeRegion.text;

        const train1Region = regions.find(r => r.id === 'train1');
        if (train1Region) document.getElementById('train1').textContent = train1Region.text + ' min*';

        const train2Region = regions.find(r => r.id === 'train2');
        if (train2Region) document.getElementById('train2').textContent = train2Region.text + ' min*';

        const tram1Region = regions.find(r => r.id === 'tram1');
        if (tram1Region) document.getElementById('tram1').textContent = tram1Region.text + ' min*';

        const tram2Region = regions.find(r => r.id === 'tram2');
        if (tram2Region) document.getElementById('tram2').textContent = tram2Region.text + ' min*';

        const weatherRegion = regions.find(r => r.id === 'weather');
        if (weatherRegion) document.getElementById('weather').textContent = weatherRegion.text;

        const tempRegion = regions.find(r => r.id === 'temperature');
        if (tempRegion) document.getElementById('temperature').textContent = tempRegion.text + '°';

        // Update info panel
        const regionDataHtml = regions.map(r =>
          `<span class="region"><strong>${r.id}:</strong> "${r.text}"</span>`
        ).join('');
        document.getElementById('regionData').innerHTML = regionDataHtml;

        // Update metadata
        document.getElementById('serverUrl').textContent = API_URL;
        document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString();
        document.getElementById('dataMode').textContent = data.weather ? 'Live' : 'Fallback';

        // Reset countdown
        countdown = 10;

      } catch (error) {
        console.error('Error fetching dashboard data:', error);
        document.getElementById('regionData').innerHTML =
          `<span class="region" style="color: #e53e3e;"><strong>Error:</strong> ${error.message}</span>`;
      }
    }

    // Countdown timer
    function startCountdown() {
      countdownInterval = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;

        if (countdown <= 0) {
          updateDashboard();
        }
      }, 1000);
    }

    // Initial load
    updateDashboard();
    startCountdown();

    // Also refresh on page focus
    window.addEventListener('focus', () => {
      updateDashboard();
    });
  </script>
</body>
</html>
