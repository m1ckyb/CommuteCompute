; PlatformIO Configuration for PTV-TRMNL Firmware
; Copyright (c) 2026 Angus Bergman - CC BY-NC 4.0

[env:ccfirm-trmnl]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800

; Use main.cpp as the production firmware (stable)
build_src_filter = +<*> -<*.cpp> +<main.cpp>

; ArduinoJson REMOVED - causes ESP32-C3 stack corruption even when heap-allocated
; Using manual JSON parsing instead
lib_deps =
    bitbank2/bb_epaper@^2.0.1

build_flags =
    -D BOARD_TRMNL
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D CONFIG_BT_ENABLED=1
    -D CONFIG_BTDM_CTRL_MODE_BLE_ONLY=1
board_build.partitions = min_spiffs.csv

; Barebones test - serial only, no libs
[env:trmnl-barebones]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<main-barebones.cpp>
build_flags =
    -D BOARD_TRMNL
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; Direct WiFi test - bypasses WiFiManager
[env:trmnl-direct]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<main-direct-wifi.cpp>
lib_deps =
    bitbank2/bb_epaper@^2.0.1
build_flags =
    -D BOARD_TRMNL
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; Display test - bb_epaper only, no WiFi
[env:trmnl-display]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<main-display-test.cpp>
lib_deps =
    bitbank2/bb_epaper@^2.0.1
build_flags =
    -D BOARD_TRMNL
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; Minimal test - no display, just WiFi/HTTP
[env:trmnl-minimal]
extends = env:trmnl
build_src_filter = +<*> -<*.cpp> +<main-v7-minimal.cpp>
lib_deps =
    tzapu/WiFiManager@^2.0.17

; Legacy v6 firmware (deprecated)
[env:trmnl-v6]
extends = env:trmnl
build_src_filter = +<*> -<*.cpp> +<main-v6.cpp> +<cc-logo.cpp>

; Libraries
lib_deps =
    bitbank2/bb_epaper@^2.0.1
    bblanchon/ArduinoJson@^7.0.0
    tzapu/WiFiManager@^2.0.17

; Build flags for TRMNL OG (ESP32-C3)
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D CONFIG_ARDUINO_USB_CDC_ON_BOOT=1

; Partition scheme
board_build.partitions = min_spiffs.csv

; Display pin test firmware (bb_epaper)
[env:trmnl-pintest]
extends = env:trmnl
build_src_filter = +<*> -<*.cpp> +<display-test.cpp>

; TRMNL test with README pinout (CLK=6 DIN=5 CS=7 DC=3 RST=2 BUSY=4)
[env:trmnl-readme-pins]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<trmnl-test.cpp>
lib_deps =
    zinggjm/GxEPD2@^1.5.8
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D CONFIG_ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; GxEPD2 display test firmware
[env:trmnl-gxepd]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<trmnl-test.cpp>
lib_deps =
    bitbank2/bb_epaper@^2.0.1
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D CONFIG_ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; Debug build
[env:trmnl-debug]
extends = env:trmnl
build_type = debug
build_flags =
    ${env:trmnl.build_flags}
    -D CORE_DEBUG_LEVEL=5
    -D DEBUG_MODE=1

; TRMNL Mini (600x448)
[env:trmnl-mini]
extends = env:trmnl
build_flags =
    ${env:trmnl.build_flags}
    -D BOARD_TRMNL_MINI
    -D SCREEN_W=600
    -D SCREEN_H=448

; Sequential zone fetching (one zone at a time, ~9KB each)
[env:trmnl-sequential]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = -<*> +<main-sequential.cpp>
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    bitbank2/bb_epaper@^2.0.1
    tzapu/WiFiManager@^2.0.17
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; NVS Bypass (hardcoded webhook, no preferences)
[env:trmnl-bypass]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = -<*> +<main-bypass.cpp>
lib_deps =
    bblanchon/ArduinoJson@^7.0.0
    bitbank2/bb_epaper@^2.0.1
    tzapu/WiFiManager@^2.0.17
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; BLE Provisioning firmware (no WiFiManager, uses Web Bluetooth)
[env:trmnl-ble]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<main-ble.cpp>
lib_deps =
    bitbank2/bb_epaper@^2.0.1
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D CONFIG_BT_ENABLED=1
    -D CONFIG_BTDM_CTRL_MODE_BLE_ONLY=1
board_build.partitions = min_spiffs.csv

; Font crash test
[env:trmnl-font-test]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<main-font-test.cpp>
lib_deps =
    bitbank2/bb_epaper@^2.0.1
build_flags =
    -D BOARD_TRMNL
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv

; Burn-in recovery (no WiFi, just display clearing)
[env:trmnl-burnin-fix]
platform = espressif32@6.12.0
board = esp32-c3-devkitc-02
framework = arduino
monitor_speed = 115200
upload_speed = 460800
build_src_filter = +<*> -<*.cpp> +<burnin-fix.cpp>
lib_deps =
    bitbank2/bb_epaper@^2.0.1
build_flags =
    -D BOARD_TRMNL
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
board_build.partitions = min_spiffs.csv
